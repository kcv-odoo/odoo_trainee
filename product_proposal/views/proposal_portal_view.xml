<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Complete page of the proposal_order -->

    <template id="product_proposal_portal_template" name="Propsal Order Portal Template"
              inherit_id="portal.portal_sidebar" primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <t t-set="o_portal_fullwidth_alert" groups="sales_team.group_sale_salesman">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url"
                       t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (proposal_order._name, proposal_order.id, action.id)"/>
                </t>
            </t>

            <div class="row mt16 o_portal_sale_sidebar">
                <!-- Sidebar -->
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-auto d-print-none'"/>

                    <t t-set="title">
                        <h2 class="mb-0">
                            <b t-field="proposal_order.proposed_total" data-id="total_amount"/>
                        </h2>
                        <!--                        WHAT IS data-id="total_amount"?? -->
                    </t>
                    <!--                    side buttons here..............-->
                    <t t-set="entries">
                        <ul class="list-group list-group-flush flex-wrap flex-row flex-lg-column">
                            <li class="list-group-item flex-grow-1">
                                <div class="o_download_pdf btn-toolbar flex-sm-nowrap">
                                    <div class="btn-group flex-grow-1 mr-1 mb-1">
                                        <a class="btn btn-secondary btn-block o_download_btn"
                                           t-att-href="proposal_order.get_portal_url(report_type='pdf', download=True)"
                                           title="Download">
                                            <i class="fa fa-download"/>
                                            DOWNLOAD
                                        </a>
                                    </div>
                                    <div class="btn-group flex-grow-1 mb-1">
                                        <a class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print"
                                           t-att-href="proposal_order.get_portal_url(report_type='pdf')"
                                           id="print_invoice_report" title="Print" target="_blank">
                                            <i class="fa fa-print"/>
                                            STAMPA
                                        </a>
                                    </div>
                                </div>
                            </li>

                            <li class="navspy list-group-item pl-0 flex-grow-1" t-ignore="true" role="complementary">
                                <ul class="nav flex-column bs-sidenav"></ul>
                            </li>


                            <li t-if="proposal_order.user_id" class="list-group-item flex-grow-1">
                                <div class="small mb-1">
                                    <strong class="text-muted">Salesperson</strong>
                                </div>
                                <div class="row flex-nowrap">
                                    <div class="col flex-grow-0 pr-2">
                                        <img class="rounded-circle mr4 float-left o_portal_contact_img"
                                             t-if="proposal_order.user_id.image_1024"
                                             t-att-src="image_data_uri(proposal_order.user_id.image_1024)"
                                             alt="Contact"/>
                                        <img class="rounded-circle mr4 float-left o_portal_contact_img"
                                             t-if="not proposal_order.user_id.image_1024"
                                             src="/web/static/src/img/placeholder.png" alt="Contact"/>
                                    </div>
                                    <div class="col pl-0" style="min-width: 150px">
                                        <span t-field="proposal_order.user_id"
                                              t-options='{"widget": "contact", "fields": ["name", "phone"], "no_marker": True}'/>
                                        <a href="#discussion" class="small">
                                            <i class="fa fa-comment"></i>
                                            Send message
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </t>
                </t>

                <!-- Page content -->
                <div id="quote_content" class="col-12 col-lg justify-content-end">


                    <!-- chatter -->
                    <div id="proposal_order_communication" class="mt-4">
                        <h2>History</h2>
                        <t t-call="portal.message_thread">
                            <t t-set="object" t-value="proposal_order"/>
                        </t>
                    </div>
                </div><!-- // #quote_content -->
            </div>
        </xpath>
    </template>
    <!--content template................-->
    <template id="product_proposal_portal_content" name="Product Proposal Portal Content">
        <!-- Intro -->
        <div id="introduction" t-attf-class="pb-2 pt-3 #{'card-header bg-white' if report_type == 'html' else ''}">
            <h2 class="my-0">
                PROPOSAL
                <em t-esc="product_proposal.name_seq"/>
            </h2>
        </div>

        <div t-attf-class="#{'card-body' if report_type == 'html' else ''}">
            <!-- Informations -->
            <div id="informations">
                <div class="row" id="so_date">
                    <div class="mb-3 col-6">
                        <t t-if="product_proposal.date_proposal">
                            <strong>Proposal Date:</strong>
                        </t>
                        <span t-field="product_proposal.date_proposal" t-options='{"widget": "date"}'/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <strong t-if="product_proposal.partner_shipping_id == sale_order.partner_invoice_id"
                                class="d-block mb-1">CUSTOMER:
                        </strong>
                        <strong t-if="product_proposal.partner_shipping_id != sale_order.partner_invoice_id"
                                class="d-block mb-1">CUSTOMER:
                        </strong>
                        <address t-field="product_proposal.partner_invoice_id"
                                 t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                    </div>
                    <t t-if="product_proposal.partner_shipping_id != product_proposal.partner_invoice_id">
                        <div id="shipping_address" class="col-lg-6">
                            <strong class="d-block mb-1">CUSTOMER:</strong>
                            <address t-field="product_proposal.partner_shipping_id"
                                     t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                        </div>
                    </t>
                </div>
            </div>

            <section id="details" style="page-break-inside: auto;" class="mt32">

                <table t-att-data-order-id="product_proposal.id" t-att-data-token="product_proposal.access_token"
                       class="table table-sm" id="product_proposal_order_table">
                    <thead class="bg-100">
                        <tr>
                            <th class="text-left">Prodotto</th>
                            <th class="text-right">Proposed Quantity</th>
                            <th t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                Proposed Price
                            </th>
                            <th class="text-right">Accepted Quantity</th>
                            <th t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                Accepted Price
                            </th>
                        </tr>
                    </thead>
                    <tbody class="sale_tbody">

                        <t t-set="current_subtotal" t-value="0"/>

                        <t t-foreach="product_proposal.proposal_line_ids" t-as="line">

                            <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"
                               groups="account.group_show_line_subtotals_tax_excluded"/>
                            <t t-set="current_subtotal" t-value="current_subtotal + line.price_total"
                               groups="account.group_show_line_subtotals_tax_included"/>

                            <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                                <t t-if="not line.display_type">
                                    <td id="product_name">
                                        <span t-field="line.name"/>
                                    </td>
                                    <td class="text-right">
                                        <div id="quote_qty">
                                            <span t-field="line.product_uom_qty"/>
                                            <span t-field="line.product_uom" groups="uom.group_uom"/>
                                        </div>
                                    </td>
                                    <td t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                        <div
                                                t-if="line.discount &gt;= 0"
                                                t-field="line.price_unit"
                                                t-att-style="line.discount and 'text-decoration: line-through' or None"
                                                t-att-class="(line.discount and 'text-danger' or '') + ' text-right'"
                                        />
                                        <div t-if="line.discount">
                                            <t t-esc="(1-line.discount / 100.0) * line.price_unit"
                                               t-options='{"widget": "float", "decimal_precision": "Product Price"}'/>
                                        </div>
                                    </td>
                                    <td t-if="display_discount"
                                        t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                        <strong t-if="line.discount &gt; 0" class="text-info">
                                            <t t-esc="((line.discount % 1) and '%s' or '%d') % line.discount"/>%
                                        </strong>
                                    </td>
                                    <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_id))"/>
                                    </td>
                                    <td class="text-right">
                                        <span class="oe_order_line_price_subtotal" t-field="line.price_subtotal"
                                              groups="account.group_show_line_subtotals_tax_excluded"/>
                                        <span class="oe_order_line_price_total" t-field="line.price_total"
                                              groups="account.group_show_line_subtotals_tax_included"/>
                                    </td>
                                </t>
                                <t t-if="line.display_type == 'line_section'">
                                    <td colspan="99">
                                        <span t-field="line.name"/>
                                    </td>
                                    <t t-set="current_section" t-value="line"/>
                                    <t t-set="current_subtotal" t-value="0"/>
                                </t>
                                <t t-if="line.display_type == 'line_note'">
                                    <td colspan="99">
                                        <span t-field="line.name"/>
                                    </td>
                                </t>
                            </tr>

                            <t t-if="current_section and (line_last or product_proposal.proposal_line_ids[line_index+1].display_type == 'line_section')">
                                <tr class="is-subtotal text-right">
                                    <td colspan="99">
                                        <strong class="mr16">Subtotal</strong>
                                        <span
                                                t-esc="current_subtotal"
                                                t-options='{"widget": "monetary", "display_currency": product_proposal.pricelist_id.currency_id}'
                                        />
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <div id="total" class="row" name="total" style="page-break-inside: avoid;">
                    <div t-attf-class="#{'col-4' if report_type != 'html' else 'col-sm-7 col-md-5'} ml-auto">
                        <t t-call="product_proposal.proposal_order_portal_content_totals_table"/>
                    </div>
                </div>
            </section>

            <section id="terms" class="mt-5" t-if="product_proposal.note">
                <h3 class="">Terms &amp; Conditions</h3>
                <hr class="mt-0 mb-1"/>
                <em t-field="product_proposal.note"/>
            </section>
        </div>
    </template>
<!-- template for total-->
 <template id="proposal_order_portal_content_totals_table">
        <table class="table table-sm">
            <tr class="border-black">
                <td><strong>Subtotal</strong></td>
                <td class="text-right">
                    <span
                        data-id="total_untaxed"
                        t-field="sale_order.amount_untaxed"
                        t-options='{"widget": "monetary","display_currency": product_proposal.pricelist_id.currency_id}'
                    />
                </td>
            </tr>
<!--            <t t-foreach="product_proposal.amount_by_group" t-as="amount_by_group" >-->
<!--                <tr>-->
<!--                    <t t-if="amount_by_group[3] == 1 and sale_order.amount_untaxed == amount_by_group[2]">-->
<!--                        <td>-->
<!--                            <span t-esc="amount_by_group[0]"/>-->
<!--                            <span>&amp;nbsp;<span>on</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/></span>-->
<!--                        </td>-->
<!--                        <td class="text-right">-->
<!--                            <span t-esc="amount_by_group[1]"-->
<!--                                t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/>-->
<!--                        </td>-->
<!--                    </t>-->
<!--                    <t t-else ="">-->
<!--                        <td>-->
<!--                            <span t-esc="amount_by_group[0]"/>-->
<!--                        </td>-->
<!--                        <td class="text-right">-->
<!--                            <span t-esc="amount_by_group[1]"-->
<!--                                t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/>-->
<!--                        </td>-->
<!--                    </t>-->
<!--                </tr>-->
<!--            </t>-->
            <tr class="border-black">
                <td><strong>Total</strong></td>
                <td class="text-right">
                    <span data-id="total_amt" t-field="product_proposal." t-options='{"widget": "monetary", "display_currency": product_proposal.pricelist_id.currency_id}'/>
                </td>
            </tr>
        </table>
    </template>
</odoo>